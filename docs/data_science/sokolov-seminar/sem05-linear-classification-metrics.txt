Машинное обучение, ФКН ВШЭ
Семинар №5
1 AUC-ROC
На лекции мы познакомились с такой важной метрикой качества бинарной
классификации, как площадь под ROC-кривой (AUC-ROC). Напомним её определе-
ние. Рассмотрим задачу бинарной классификации с метками классов Y = {−1, +1}, и
пусть задан некоторый алгоритм b(x), позволяющий вычислять оценку принадлеж-
ности объекта x положительному классу. AUC-ROC позволяет оценивать качество
классификации для семейства алгоритмов следующего вида:
a(x; t) =
(
−1, b (x) ≤ t,
+1, b (x) > t,
т.е. алгоритмов, присваивающих метки объектам в соответствии с оценками b(x),
отсекая их по некоторому порогу t. Каждый алгоритм (получающийся при фиксации
значения порога t) представляется точкой на плоскости (FPR, TPR), где
FPR = FP
FP + TN = FP
ℓ−
,
TPR = TP
TP + FN = TP
ℓ+
,
ℓ−, ℓ+ — количество объектов отрицательного и положительного классов соответ-
ственно. AUC-ROC, в свою очередь, является площадью под получившейся кривой.
Изучим подробнее некоторые важные свойства данной метрики.
Критерий AUC-ROC имеет большое число интерпретаций — например, он равен
вероятности того, что случайно выбранный положительный объект окажется позже
случайно выбранного отрицательного объекта в ранжированном списке, порожден-
ном b(x). Разберем подробнее немного другую формулировку.
Задача 1.1. В ранжировании часто используется функционал «доля дефектных
пар». Его можно определить и для задачи бинарной классификации.
Пусть дан классификатор b(x), который возвращает оценки принадлежности
объектов классу +1, и пусть все значения b(xi), i = 1, ℓ, для некоторой выборки
X = {(xi, yi)}ℓ
i=1 различны. Отсортируем все объекты по возрастанию ответа клас-
сификатора: b(x(1)) < · · · < b (x(ℓ)). Обозначим истинные ответы на этих объектах
1
2
через y(1), . . . , y(ℓ). Тогда доля дефектных пар записывается как
DP(b, X) = 2
ℓ(ℓ − 1)
ℓX
i<j
[y(i) > y(j)].
Как данный функционал связан с AUC-ROC?
Решение. Для начала разберем процедуру построения ROC-кривой. Сперва все
объекты сортируются по неубыванию оценки b(x), тем самым формируя список
x(1), . . . , x(ℓ). Заметим, что для построения ROC-кривой достаточно рассмотреть
(ℓ + 1) различных значений порога t, соответствующих всем различным способам
классификации выборки, порожденным алгоритмом b(x), — например, в качестве
таких порогов можно рассмотреть следующий набор:
tℓ = b(x(ℓ)) + 1,
ti = b(x(i)) +b(x(i+1))
2 , i = 1, ℓ − 1,
t0 = b(x(1)) − 1.
Зафиксируем значение порога t = tℓ = b(x(ℓ)) + 1, в этом случае имеем
FPR = FP
ℓ−
= 0
ℓ−
= 0,
TPR = TP
ℓ+
= 0
ℓ+
= 0.
Таким образом, алгоритму a(x; tℓ) соответствует точка (0; 0) на плоскости, откуда
начинается построение ROC-кривой. Будем перебирать пороги в порядке невозрас-
тания их значения, начиная с tℓ. Пусть мы хотим уменьшить значение порога с ti до
ti−1. При этом классификация объекта x(i) (и только его) изменится с отрицательной
на положительную. Рассмотрим 2 случая.
1. y(i) = +1. В этом случае классификатор начнет верно классифицировать объ-
ект, на котором ранее допускал ошибку, при этом FPR не изменится, а TPR
повысится на 1
ℓ+
.
2. y(i) = −1. В этом случае классификатор начнет ошибаться на объекте, который
ранее классифицировал верно, при этом TPR не изменится, а FPR повысится
на 1
ℓ−
.
3
Теперь рассмотрим, как при этом изменяется AUC-ROC. Заметим, что область
под ROC-кривой состоит из непересекающихся прямоугольников, каждый из кото-
рых снизу ограничен осью FPR, а сверху — одним из горизонтальных отрезков, соот-
ветствующих второму из рассмотренных случаев. Поэтому каждый раз, когда имеет
место второй случай, к текущей накопленной площади под кривой (которая изна-
чально в точке (0; 0) равна 0) добавляется площадь прямоугольника, горизонталь-
ные стороны которого равны 1
ℓ−
, а вертикальные равны 1
ℓ+
Pℓ
j=i+1[y(j) = +1] (доля
уже рассмотренных положительных объектов среди всех положительных), поэтому
в этом случае текущее значение AUC-ROC увеличивается на 1
ℓ−ℓ+
Pℓ
j=i+1[y(j) = +1].
Итого, финальное значение AUC-ROC можно посчитать следующим образом:
AUC = 1
ℓ+ℓ−
ℓX
i=1
[y(i) = −1]
ℓX
j=i+1
[y(j) = +1] =
= 1
ℓ+ℓ−
ℓX
i=1
ℓX
j=i+1
[y(i) < y(j)] =
= 1
ℓ+ℓ−
ℓX
i<j
(1 − [y(i) = y(j)] − [y(i) > y(j)]) =
= 1
ℓ+ℓ−
ℓX
i<j
(1 − [y(i) = y(j)]) − 1
ℓ+ℓ−
ℓX
i<j
[y(i) > y(j)] =
= 1
ℓ+ℓ−
ℓX
i<j
([y(i) ̸= y(j)]) − 1
ℓ+ℓ−
ℓX
i<j
[y(i) > y(j)] =
= ℓ+ℓ−
ℓ+ℓ−
− 1
ℓ+ℓ−
ℓX
i<j
[y(i) > y(j)] = 1− 1
ℓ+ℓ−
X
i<j
[y(i) > y(j)].
4
Отсюда получаем, что AUC-ROC и доля дефектных пар связаны следующим соот-
ношением:
DP(b, X) = 2ℓ−ℓ+
ℓ(ℓ − 1)(1 − AUC(b, X))).
■
Заметим, что в случае, когда несколько объектов выборки имеют равные значе-
ния b(x), при уменьшении значения порога с ti > b(x) до ti−1 < b(x), где x — один из
таких объектов, изменение значений FPR и TPR происходит одновременно, поэтому
соответствующий участок ROC-кривой будет наклонным, а не горизонтальным или
вертикальным.
Задача 1.2. Пусть даны выборка X, состоящая из 5 объектов, и классифика-
тор b(x), предсказывающий оценку принадлежности объекта положительному клас-
су. Предсказания b(x) и реальные метки объектов приведены ниже:
b(x1) = 0.2, y 1 = −1,
b(x2) = 0.4, y 2 = +1,
b(x3) = 0.1, y 3 = −1,
b(x4) = 0.7, y 4 = +1,
b(x5) = 0.05, y 5 = +1.
Вычислите AUC-ROC для множества классификаторов a(x; t), порожденного b(x),
на выборке X.
Решение. В соответствии с процессом построения ROC-кривой, описанным в преды-
дущей задаче, отсортируем оценки b(xi) в порядке их неубывания: (b(x(i)))ℓ
i=1 =
= (0.05, 0.1, 0.2, 0.4, 0.7). Также составим последовательность реальных меток объ-
ектов из этого упорядоченного списка: (y(i))ℓ
i=1 = (+1, −1, −1, +1, +1).
Построим ROC-кривую (см. рис. 1), откуда AUC-ROC = 2
3 .
■
Рис. 1.Иллюстрация к задаче 1.2.
5
Заметим, что при вычислении AUC-ROC на некоторой выборке X для итого-
вого классификатора a(x; t) важны не конкретные значения b(xi), i = 1, ℓ, а порядок
расположения объектов в отсортированном по неубыванию списке b(x(1)), . . . , b(x(ℓ)),
порожденным алгоритмом b(x). Таким образом, для фиксированной выборки X ал-
горитм b(x) задаёт перестановку на её объектах, которая в дальнейшем используется
при расчёте AUC-ROC.
Задача 1.3. Пусть b(x) — классификатор, предсказывающий оценку принадлеж-
ности объекта x классу +1 таким образом, что для некоторой выборки X он равно-
вероятно выдаёт на её объектах одну из всех возможных перестановок. Чему равно
матожидание AUC-ROC этого классификатора?
Решение. Как было показано в задаче 1.1, для AUC-ROC верно
AUC = 1
ℓ+ℓ−
ℓX
i<j
[y(i) = −1][y(j) = +1],
поэтому
EAUC = 1
ℓ+ℓ−
ℓX
i<j
E([y(i) = −1][y(j) = +1]).
Заметим, что величина [y(i) = −1][y(j) = +1] принимает значения 0 и 1, поэтому
E([y(i) = −1][y(j) = +1]) =P(y(i) = −1, y (j) = +1) =ℓ−ℓ+(ℓ − 2)!
ℓ! = ℓ−ℓ+
ℓ(ℓ − 1).
Отсюда имеем
EAUC = 1
ℓ−ℓ+
ℓX
i<j
ℓ−ℓ+
ℓ(ℓ − 1) = ℓ(ℓ − 1)
2
1
ℓ(ℓ − 1) = 1
2.
■
Итого, можем заметить, что значение AUC-ROC, близкое к 1
2 , означает, что
классификатор близок к случайному, тогда как значение, равное 1, означает, что
классификатор безошибочно классифицирует объекты при некотором значении по-
рога.
Задача 1.4. Пусть b(x) — некоторый классификатор, предсказывающий оценку
принадлежности объекта x положительному классу, и при этом AUC-ROC множества
классификаторов a(x; t), порожденных b(x), на некоторой выборке X принимает зна-
чение, меньшее 0.5. Как можно скорректировать прогнозы классификаторов a(x; t),
чтобы они были более осмысленными по сравнению с прогнозами классификатора,
выдающего случайные ответы?
Решение.
Для некоторого классификатора a(x; t) рассмотрим классификатор a∗(x; t), вы-
дающий противоположные метки по сравнению с a(x; t), т.е.:
a∗(x; t) =−a(x; t).
6
При этом TP и FP на обучающей выборке для некоторого классификатора a∗(x; t)
будут принимать следующие значения:
TP(a∗(x; t), X) =
ℓX
i=1
[yi = +1][a∗(x; t) = +1] =
=
ℓX
i=1
[yi = +1][a(x; t) =−1] =FN(a(x; t), X),
FP(a∗(x; t), X) =
ℓX
i=1
[yi = −1][a∗(x; t) = +1] =
=
ℓX
i=1
[yi = −1][a(x; t) =−1] =TN(a(x; t), X).
Отсюда имеем
TPR(a∗(x; t), X) = TP(a∗(x; t), X)
ℓ+
= FN(a(x; t), X)
ℓ+
=
= ℓ+ − TP(a(x; t), X)
ℓ+
= 1− TPR(a(x; t), X),
FPR(a∗(x; t), X) = FP(a∗(x; t), X)
ℓ−
= TN(a(x; t), X)
ℓ−
=
= ℓ− − FP(a(x; t), X)
ℓ−
= 1− FPR(a(x; t), X),
поэтому классификатор a∗(x; t) будет представлен на плоскости точкой, симметрич-
ной точке, отвечающей классификатору a(x; t), относительно точки (0.5; 0.5).
Рассмотрим ROC-кривую для множества классификаторов a(x; t). Пусть пло-
щадь областей единичного квадрата, находящихся между его диагональю и частями
ROC-кривой, расположенных под ней, равна S−, а между диагональю и частями
ROC-кривой, расположенных над диагональю, — S+. Тогда AUC-ROC для такой
кривой принимает значение 0.5 +S+ − S− < 0.5 (по условию), отсюда S+ − S− < 0.
Как было показано ранее, ROC-кривая для множества классификаторов a∗(x; t)
симметрична ROC-кривой для множества классификаторов a(x; t), а потому для пер-
вой кривой область, соответствующая площади S−, будет расположена над диагона-
лью единичного квадрата, площади S+ — под диагональю. Отсюда AUC-ROC для
множества классификаторов a∗(x; t) будет принимать значение 0.5 − S+ + S− > 0.5,
а потому прогнозы классификаторов из этого множества более осмысленны по срав-
нению со случайным классификатором.
■
Задача 1.5. На ответах алгоритма b(x), отнормированных на интервал от 0 до 1,
объекты отрицательного класса распределены с плотностью p(b) = 2−2b, а объекты
положительного класса распределены с плотностью p(b) = 2b (см. рис. 2). Выпишите
формулу для ROC-кривой и посчитайте площадь под ней.
Решение. Для выбранного порога бинаризации t значение TPR будет равно отно-
шению площади трапеции, отсекаемой вертикальной прямой y = t под синей прямой
7
Рис. 2.Распределение объектов положительного и отрицательного классов
(см. рисунок) к площади всего треугольника под синей прямой. Площадь под си-
ней прямой равна единице (во-первых, по условию синяя прямая задаёт плотность,
во-вторых, можно проверить вручную). Площадь трапеции можно выразить как раз-
ность площадей треугольников: TPR (t) = 1−t·2t
2 = 1−t2. Для FPR идея аналогичная,
но нужно посчитать площадь треугольника, а не трапеции: FPR (t) = 1
2 (1−t)(2−2t) =
= (1−t)2. Теперь можно выразить TPR через FPR: TPR (t) = 1−(1 −
p
FPR (t))2 =
= 2
p
FPR (t) − FPR (t). Значит, ROC-кривая задаётся уравнением y = 2√x − x.
График этой кривой можно увидеть на рис. 3. Площадь под ней можно посчитать,
взяв следующий интеграл:
1Z
0
(2√x − x)dx =
4
3x
3
2 − 1
2x2

1
0
= 5
6.
0.0 0.2 0.4 0.6 0.8 1.0
False Positive Rate
0.0
0.2
0.4
0.6
0.8
1.0True Positive Rate
Рис. 3.ROC-кривая из задачи1.5
■
Задача 1.6. Пусть в выборке X всего ℓ+ объектов положительного класса и ℓ−
объектов отрицательного класса. Пусть Axy – это множество всех перестановок эле-
ментов X, для которых можно выбрать порог так, чтобы получить FP = x, FN = y.
Чему равно математическое ожидание AUC ROC для классификатора, равноверо-
ятно выдающего одну из перестановок из множества Axy?
8
Решение. Для AUC ROC верно
AUC = 1
ℓ+ℓ−
ℓX
i<j
[y(i) = −1][y(j) = +1].
Заметим, что если для перестановки возможно выбрать порог классификации,
удовлетворяющий FP = x, FN = y, то сделать это можно единственным способом.
Чтобы получить FN = y, нам нужно иметь TP = ℓ+ − y; чтобы получить FP = x,
должно выполняться TN = ℓ− −x. Значит, порог отделяет N = ℓ− −x+y наименьших
элементов от ℓ+ −y + x наибольших элементов. Тогда разобьём сумму из выражения
выше на 3 части:
1. A1 =
ℓP
i⩽N<j
[y(i) = −1][y(j) = +1] – сумма по парам, лежащим по разные стороны
от порога. Эту сумму легко посчитать: она равна произведению TN ·TP = (ℓ− −
− x)(ℓ+ − y).
2. A2 =
NP
i<j
[y(i) = −1][y(j) = +1]– сумма по парам, оба элемента в которых меньше
порога (помечены моделью как отрицательные). Введём 1 ⩽ α1 < . . . < α y ⩽ N
– позиции ложноотрицательных объектов. Через них эту сумму можно перепи-
сать так:
A2 =
NX
j=2
[y(j) = +1]
j−1X
i=1
[y(i) = −1] =
yX
k=1
αk−1X
i=1
[y(i) = −1] =
yX
k=1
(αk − k) =
=
yX
k=1
αk − y(y + 1)
2 .
3. A3 =
ℓP
N<i<j
[y(i) = −1][y(j) = +1] – сумма по парам, оба элемента в которой
больше порога (помечены моделью как положительные). Аналогично прошло-
му пункту введём N < β 1 < . . . < β x ⩽ l – позиции ложноположительных
объектов. Через них эту сумму можно переписать так:
A3 =
ℓX
i=N+1
[y(i) = −1]
ℓX
j=i+1
[y(j) = +1] =
xX
k=1
ℓX
j=βk+1
[y(j) = +1] =
xX
k=1
(ℓ−βk−(x−k)) =
= x(ℓ − x) +x(x + 1)
2 −
xX
k=1
βk = xℓ − x(x − 1)
2 −
xX
k=1
βk.
В итоге AUC можно записать так:
A1 + A2 + A3
ℓ+ℓ−
= 1
ℓ+ℓ−
 
ℓ+ℓ− + xy + ℓ−(x − y) − y(y + 1)
2 − x(x − 1)
2 +
yX
k=1
αk −
xX
k=1
βk
!
Теперь для подсчёта математического ожидания всего выражения нам доста-
точно посчитать математическое ожидание αk и βk. При фиксированном значении
9
αk = s есть Ck−1
s−1 вариантов выбрать меньшие α и Cy−k
N−s вариантов выбрать бОльшие
α (считаем, что если в биномиальном коэффициенте Ck
n выполнено n < k , то он ра-
вен нулю). Всего вариантов выбрать позиции для ложноположительных элементов
– Cy
N . Тогда по определению математическое ожидание записывается так:
Eαk =
NP
s=1
sCk−1
s−1 Cy−k
N−s
Cy
N
Выпишем математическое ожидание суммы (воспользуемся свёрткой Вандермонда):
E
 yX
k=1
αk
!
=
NP
s=1
s
yP
k=1
Ck−1
s−1 Cy−k
N−s
Cy
N
=
NP
s=1
sCy−1
N−1
Cy
N
= N(N + 1)
2
(N − 1)!
(y − 1)!(N − y)!
y!(N − y)!
N! =
= y(N + 1)
2 .
Для математического ожидания βk аналогичным способом получаем формулы:
Eβk =
ℓP
s=N+1
sCk−1
s−N−1Cx−k
ℓ−s
Cx
ℓ−N
; E
 xX
k=1
βk
!
=
ℓP
s=N+1
sCx−1
ℓ−N−1
Cx
ℓ−N
= x(ℓ + N + 1)
2 .
Подставим в обе формулы N = ℓ− − x + y :
E
 yX
k=1
αk
!
= y(ℓ− − x + y + 1)
2 ; E
 xX
k=1
βk
!
= x(ℓ + ℓ− − x + y + 1)
2 .
Тогда при подстановке в итоговую формулу получаем
EAUC = 1
ℓ+ℓ−

ℓ+ℓ− − 1
2 (yℓ− + xℓ+)

= 1− 1
2
y
ℓ+
+ x
ℓ−

.
■
Альтернативное решение.Для начала найдём матожидание AUC ROC для клас-
сификатора, равновероятно выдающего одну из перестановок из множества всех пе-
рестановок. Для этого сгруппируем каждую перестановку с той, в которой элементы
идут в обратном порядке: их суммарная AUC ROC равна единице.
Значит, матожидание AUC ROC такого классификатора будет равно 1
2 .
Вернёмся к исходной задаче. Нам известно, что есть такой порог, при котором
FP = x, FN = y. Тогда при этом пороге TP = ℓ+ − FN = ℓ+ − y, TPR = T P
ℓ+
=
= ℓ+−y
ℓ+
= 1 − y
ℓ+
, FPR = F P
ℓ−
= x
ℓ−
. Это условие равнозначно тому, что ROC-кривая
для данной перестановки проходит через точку

1 − y
ℓ+
, x
ℓ−

.
Разобьём Axy на непересекающиеся подмножества таким образом, что в каж-
дом подмножестве классификатор при пороге, соответствующем точке

1 − y
ℓ+
, x
ℓ−

,
приписывал положительному классу одни и те же объекты, и рассмотрим одно из
таких подмножеств.
10
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
ROC curve for the initial sequence
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
ROC curve for the reversed sequence
Также разобьем единичный квадрат на четыре прямоугольника горизонталь-
ной и вертикальной прямыми, проходящими через точку

1 − y
ℓ+
, x
ℓ−

. Заметим, что
правый нижний прямоугольник целиком окажется под кривой, как бы она не про-
ходила, верхний левый прямоугольник, напротив, всегда будет оказываться над ней.
Осталось лишь заметить, что поведение ROC-кривой в любом из оставшихся двух
прямоугольников в силу выбора подмножества полностью совпадает с поведением
обычной ROC-кривой в единичном квадрате. Значит, согласно вышесказанному, ма-
тожидание площади под ROC-кривой в левом нижнем и правом верхнем прямоуголь-
никах равно половине площади этих прямоугольников.
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
ROC curve example
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
Expected AUC
Посчитаем итоговое матожидание: E[AUC ROC ] =

1 − y
ℓ+

1 − x
ℓ−

+
+ 1
2

y
ℓ+

1 − x
ℓ−

+ 1
2

1 − y
ℓ+

x
ℓ−

= 1− 1
2

y
ℓ+
+ x
ℓ−

.
Также можно заметить, что половина площади прямоугольника равна площади
треугольника, отсекаемого от прямоугольника диагональю, а значит, матожидание
площади под кривой, проходящей через заданную точку, равно площади под лома-
11
ной, получающейся при соединении этой точки с левым нижним и правым верхним
углами единичого квадрата (см. изображение справа).
Данный подход легко обобщается на любое множество зафиксированных то-
чек, через которые должна пройти ROC-кривая! Снова разбиваем множество всех
перестановок, у которых ROC-кривая проходит через все заданные точки, на под-
множества. В каждое подмножество объединяем все перестановки, в которых для
каждого из пороговых значений, соответствующих зафиксированным точкам, в по-
ложительный класс попадают одни и те же объекты. Так же, как и для одной точки,
разбиваем единичный квадрат на прямоугольники вертикальными и горизонтальны-
ми прямыми, проходящими через множество зафиксированных точек.
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
ROC curve example
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
FPR
0.00
0.05
0.10
0.15
0.20
0.25
0.30
0.35
0.40
0.45
0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90
0.95
1.00TPR
Expected AUC
Те прямоугольники, которые оказались одновременно ниже и правее хотя бы
одной зафиксированной точки, гарантированно окажутся под ROC-кривой, а ока-
завшиеся выше и левее хотя бы одной из точек точно окажутся над ROC-кривой.
Наконец, матожидание площади области, оказавшейся под ROC-кривой в каждом
из оставшихся прямоугольников, будет равно половине площади каждого из таких
прямоугольников, а значит, площадь под ломаной, проходящей через все отмеченные
точки, левый нижний и правый верхний углы единичного квадрата, будет в точно-
сти равна матожиданию площади под ROC-кривой, наугад выбранной из множества
кривых, проходящих через все зафиксированные точки!
Задача 1.7. У банка всего 4000 клиентов. Маркетингового бюджета нового пред-
ложения банка хватит на то, чтобы обзвонить 800 клиентов. По историческим дан-
ным аналитики банка выяснили, что лишь 6% клиентов действительно начинают
пользоваться новым предложением после маркетингового звонка. У компании уже
есть два классификатора A и B, для которых положительный класс – это клиен-
ты, которые отреагируют на маркетинговый звонок, а отрицательный – клиенты,
на которых он не повлияет. Известно, что для A FPR = 0.1, TPR = 0.2, а для B
FPR = 0.25, TPR = 0.6. Постройте на их основе классификатор, который выберет
ровно 800 клиентов для совершения маркетинговых звонков.
Решение. Запишем условие на то, что классификатор выберет ровно 800 клиентов:
FPR ·ℓ− + TPR ·ℓ+ = 800. Это можно представить в виде прямой, заданной в том же
12
пространстве, что и ROC-кривая. Чему равны ℓ− и ℓ+ в нашем случае? Воспользуемся
данными аналитиков и получим, что среди всех клиентов будет 0.06 · 4000 = 240
клиентов, относящихся к положительному классу, и 3760 клиентов, относящихся к
отрицательному классу.
Посмотрим, сколько объектов положительного класса нам выдадут классифи-
каторы A и B. Для A: 0.1 · 3760 + 0.2 · 240 = 424– слишком мало Для B: 0.25 · 3760 +
+ 0.6 · 240 = 1084– слишком много.
Проведём отрезок между точками A и B в пространстве ROC-кривой. Заметим,
что мы можем получить любой классификатор с парой характеристик (FPR, TPR ),
лежащей на этом отрезке. Для этого нам достаточно брать предсказания данных
двух классификаторов с вероятностями, пропорциональными расстояниям от точки
до концов отрезков.
Выпишем уравнение прямой, проходящей через точки A и B, и найдём её точку
пересечения с прямой, заданной в условии. Для прямой, проходящей через точки A
и B верно, что
(
0.2 =a · 0.1 +b
0.6 =a · 0.25 +b ⇔
(
b = 0.2 − a · 0.1
0.4 =a · 0.15 ⇔
(
a = 8
3
b = − 1
15
.
Значит, нам надо найти точку пересечения прямых TPR = 8
3 ·FPR − 1
15 и TPR = 10
3 −
− 47
3 · FPR. Получаем точку FPR = 51
275 , TPR = 353
825 . Осталось посчитать отношение,
в котором эта точка делит отрезок:
51
275 − 1
10
1
4 − 1
10
= 94
165.
Значит, для получения искомого классификатора с вероятностью 94
165 ≈ 0.57 надо
брать предсказание классификатора B, иначе – предсказание классификатора A.
Иллюстрацию к задаче можно найти на рис. 4.
Рис. 4.Иллюстрация к задаче1.7.
■
13
Задача 1.8. Зафиксируем число объектов положительного ( ℓ+) и отрицательного
(ℓ−) классов. Докажите, что ROC-кривая классификатора A не ниже ROC-кривой
классификатора B в любой точке тогда и только тогда, когда PR-кривая классифи-
катора A не ниже PR-кривой классификатора B в любой точке.
Решение. Докажем, что если ROC-кривая выше, то и PR-кривая выше. Выберем
для двух классификаторов такие пороги t1 и t2, что TPR A(t1) = TPR B(t2). Про-
верим, как при этом соотносятся их точности. Известно, что ROC-кривая A выше
ROC-кривой B, поэтому FPR A(t1) ⩽ FPR B(t2) ⇔ FPA(t1) ⩽ FPB(t2). Вспомним
формулу для точности: PRA(t) = T PA(t)
T PA(t)+F PA(t) . Из условия TPR A(t1) = TPR B(t2)
следует равенство TPA(t1) =TPB(t2), а значит, PRA(t1) и PRB(t2) отличаются толь-
ко за счёт FP в знаменателе. Воспользовавшись полученным выше неравенством на
FP , получаем, что PRA(t1) ⩾ PRB(t2), ч.т.д..
Доказательство в обратную сторону проделывается абсолютно аналогично: на-
до зафиксировать пороги с равной полнотой и сравнить точности. Как и в прошлом
случае, точности будут отличаться только за счёт FP , так что из неравенства точ-
ностей мы получим неравенство для FPR .
■
Задача 1.9. Рассмотрим задачу классификации с выборкой X и долей объектов с
y = +1 равной 0.5. Разделим ее на две равные части: X1 и X2. Баланс классов в них
равен p1 и p2 соответственно. Легко показать, что p1 = 1− p2.
Будем говорить, что X1 и X2 – это два сегмента нашей выборки. На них ис-
пользуются два разных классификатора a1(x) и a2(x). Модель на всей выборке можно
записать так:
a(x) =a1(x) [x ∈ X1] +a2(x) [x ∈ X2]
Пусть на каждом сегменте работает случайный классификатор:
AUC(a1) =AUC(a2) = 0.5
Может ли AUC (a) быть больше? Каким может быть качество модели на всей вы-
борке?
Решение. Воспользуемся вероятностным определением метрики ROC AUC:
AUC(a) =P

a(xi) > a(xj) | yi = +1, y j = −1
	
Проведем вероятностный эксперимент: выберем случайный объект положительного
класса и случайный объект отрицательного класса. Вероятность того, что на первом
объекте ответ модели больше, и является ROC AUC модели.
Рассмотрим такой вероятностный эксперимент для классификатора a. Случай-
ный положительный объект принадлежит первому сегменту X1 с вероятностью
p1
p1 + p2
= p1
p1 + 1− p1
= p1
И с вероятностью 1 − p1 – второму сегменту, X2.
14
Аналогично случайный отрицательный объект принадлежит первому сегмен-
ту X1 с вероятностью
1 − p1
1 − p1 + 1− p2
= 1 − p1
1 − p1 + p1
= 1− p1
И с вероятностью p1 – второму сегменту, X2.
Если и положительный, и отрицательный объект принадлежат X1, то
P {a(xi) > a(xj) | yi = +1, y j = −1, x i, x j ∈ X1} = AUC(a1) = 0.5
Обозначим эту вероятность auc 11. Оба объекта принадлежат первому сегменту с ве-
роятностью δ11 = p1(1 − p1). Аналогично с вероятностью δ22 = p1(1 − p1) оба объекта
принадлежат X2, и auc22 = 0.5.
Но что будет, если положительный объект из X1, а отрицательный из X2? Пред-
положим, что предсказания модели на первом сегменте всегда большепредсказаний
модели на втором.
a1(xi) > a2(xj) ∀xi ∈ X1, x j ∈ X2
Тогда auc12 = 1, и это происходит с вероятностью δ12 = p2
1. А с вероятностью δ21 =
= (1− p1)2 получим положительный объект из X2 и отрицательный – из X1. В этом
случае auc 21 = 0.
Вычислим AUC (a) по формуле полной вероятности:
AUC(a) =auc11 δ11 + auc12 δ12 + auc21 δ21 + auc22 δ22 =
= 0.5p1(1 − p1) +p2
1 + 0.5p1(1 − p1) =p1
Получаем, что AUC (a) может принимать любые значения от 0 до 1.
Качество на всей выборке зависит от баланса классов на подвыборках после
разбиения на сегменты. Если это разбиение случайно ( p1 = p2 = 0.5), то и качество
на всей выборке не будет отличаться от качества на отдельных сегментах. Если же
разбиение на сегменты информативно, то сам этот факт может усилить модель.
■
§1.1 Прямая оптимизация AUC-ROC
При обучении модели в бинарной классификации чаще всего решается задача
минимизации верхней оценки функционала ошибки:
Q(a, X) = 1
ℓ
ℓX
i=1
[a(xi) ̸= yi] ≤ 1
ℓ
ℓX
i=1
˜L(Mi) → min
w
Однако иногда возникает необходимость оптимизировать более сложные мет-
рики — в частности, AUC-ROC. Напрямую оптимизировать подобные метрики не
представляется возможным из-за их дискретной структуры, однако мы можем ис-
пользовать трюк с верхней оценкой функционала ошибки и в этом случае. В зада-
че 1.1 мы показали, что AUC-ROC связан с долей дефектных пар в выборке, поэтому
15
максимизация AUC-ROC равносильна минимизации доли дефектных пар.
DP (b, X) = 2
ℓ(ℓ − 1)
ℓX
i<j
[yi < yj][b(xi) > b(xj)] =
2
ℓ(ℓ − 1)
ℓX
i<j
[yi < yj][b(xj) − b(xi) < 0] ≤ 2
ℓ(ℓ − 1)
ℓX
i<j
[yi < yj] ˜L(b(xj) − b(xi)) → min
b
Если верхняя оценка ˜L дифференцируема по параметрам модели, то можно оптими-
зировать такой функционал при помощи градиентных методов.
